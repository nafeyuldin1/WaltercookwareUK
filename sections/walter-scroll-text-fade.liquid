{% comment %}
  Section: Scroll Text Fade
  Description: Lines fade in and scale up as they reach the center of the viewport.
{% endcomment %}

{%- style -%}
  #shopify-section-{{ section.id }} .scroll-fade-section {
    background-color: {{ section.settings.bg_color }};
    text-align: center;
    padding-top: {{ section.settings.pt_d }}px;
    padding-bottom: {{ section.settings.pb_d }}px;
    padding-left: 16px;
    padding-right: 16px;
    overflow: hidden;
  }

  /* Base Line Styles */
  #shopify-section-{{ section.id }} .scroll-fade-line {
    font-family: {{ section.settings.font_family.family }}, {{ section.settings.font_family.fallback_families }};
    font-weight: {{ section.settings.font_family.weight }};
    line-height: 130%;
    letter-spacing: 0.02em;
    text-align: center;
    text-transform: capitalize;
    margin: {{ section.settings.line_gap }}px 0;
    transition: opacity 0.4s ease, font-size 0.4s ease, color 0.4s ease;
    color: {{ section.settings.inactive_color }}; /* Inactive Color */
    will-change: opacity, font-size;
  }

  /* Focused/Active State */
  #shopify-section-{{ section.id }} .scroll-fade-line.sfs-focused {
    font-size: {{ section.settings.active_font_size_d }}px !important;
    opacity: 1 !important;
    color: {{ section.settings.active_color }} !important;
  }

  /* --- Dynamic Block Styles --- */
  {%- for block in section.blocks -%}
    .line-block-{{ block.id }} {
      font-size: {{ block.settings.base_size_d }}px;
      opacity: {{ block.settings.base_opacity | divided_by: 100.0 }};
    }
    
    /* Visibility Logic */
    {%- if block.settings.visibility == 'desktop' -%}
      @media (max-width: 768px) { .line-block-{{ block.id }} { display: none; } }
    {%- elsif block.settings.visibility == 'mobile' -%}
      .line-block-{{ block.id }} { display: none; }
      @media (max-width: 768px) { .line-block-{{ block.id }} { display: block; } }
    {%- endif -%}
  {%- endfor -%}

  /* --- Mobile Responsive --- */
  @media (max-width: 768px) {
    #shopify-section-{{ section.id }} .scroll-fade-section {
      padding-top: {{ section.settings.pt_m }}px;
      padding-bottom: {{ section.settings.pb_m }}px;
    }

    #shopify-section-{{ section.id }} .scroll-fade-line.sfs-focused {
      font-size: {{ section.settings.active_font_size_m }}px !important;
    }

    {%- for block in section.blocks -%}
      .line-block-{{ block.id }} {
        font-size: {{ block.settings.base_size_m }}px;
      }
    {%- endfor -%}
  }
{%- endstyle -%}

<div class="scroll-fade-section" id="scroll-fade-{{ section.id }}">
  {%- for block in section.blocks -%}
    <p class="scroll-fade-line line-block-{{ block.id }}" {{ block.shopify_attributes }}>
      {{ block.settings.text }}
    </p>
  {%- endfor -%}
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('scroll-fade-{{ section.id }}');
  if(!container) return;
  
  const lines = container.querySelectorAll('.scroll-fade-line');

  function updateOnlyFocusedLine() {
    const centerY = window.innerHeight / 2;
    let closestIndex = -1;
    let minDistance = Infinity;

    // Check only visible lines
    lines.forEach((line, index) => {
      // Check if element is visible (display none check)
      if(window.getComputedStyle(line).display === 'none') return;

      const rect = line.getBoundingClientRect();
      const lineCenter = rect.top + rect.height / 2;
      const distance = Math.abs(centerY - lineCenter);

      // Threshold to activate (must be somewhat on screen)
      if (distance < minDistance) {
        minDistance = distance;
        closestIndex = index;
      }
    });

    lines.forEach((line, index) => {
      if (index === closestIndex) {
        line.classList.add('sfs-focused');
        // Inline opacity overrides CSS, ensures it stays visible active
        line.style.opacity = '1'; 
      } else {
        line.classList.remove('sfs-focused');
        line.style.opacity = ''; // Removes inline, falls back to CSS/Block setting
      }
    });
  }

  // Init
  updateOnlyFocusedLine();
  
  // Events
  window.addEventListener('scroll', updateOnlyFocusedLine, { passive: true });
  window.addEventListener('resize', updateOnlyFocusedLine);
  
  // Theme Editor Support
  document.addEventListener('shopify:section:load', function(e){
    if(e.target.contains(container)) updateOnlyFocusedLine();
  });
});
</script>

{% schema %}
{
  "name": "Scroll Text Fade",
  "settings": [
    {
      "type": "header",
      "content": "Global Colors"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#00221c"
    },
    {
      "type": "color",
      "id": "active_color",
      "label": "Active Text Color (Focused)",
      "default": "#BCA588"
    },
    {
      "type": "color",
      "id": "inactive_color",
      "label": "Inactive Text Color",
      "default": "#BCA588"
    },
    {
      "type": "header",
      "content": "Typography & Sizes"
    },
    {
      "type": "font_picker",
      "id": "font_family",
      "label": "Font Family",
      "default": "sans-serif"
    },
    {
      "type": "range",
      "id": "active_font_size_d",
      "min": 40,
      "max": 100,
      "step": 2,
      "unit": "px",
      "label": "Active Font Size (Desktop)",
      "default": 64
    },
    {
      "type": "range",
      "id": "active_font_size_m",
      "min": 20,
      "max": 60,
      "step": 1,
      "unit": "px",
      "label": "Active Font Size (Mobile)",
      "default": 32
    },
    {
      "type": "range",
      "id": "line_gap",
      "min": 10,
      "max": 60,
      "step": 2,
      "unit": "px",
      "label": "Gap Between Lines",
      "default": 24
    },
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "pt_d",
      "min": 0,
      "max": 400,
      "step": 10,
      "unit": "px",
      "label": "Top Padding (Desktop)",
      "default": 240
    },
    {
      "type": "range",
      "id": "pb_d",
      "min": 0,
      "max": 400,
      "step": 10,
      "unit": "px",
      "label": "Bottom Padding (Desktop)",
      "default": 240
    },
    {
      "type": "range",
      "id": "pt_m",
      "min": 0,
      "max": 200,
      "step": 5,
      "unit": "px",
      "label": "Top Padding (Mobile)",
      "default": 140
    },
    {
      "type": "range",
      "id": "pb_m",
      "min": 0,
      "max": 200,
      "step": 5,
      "unit": "px",
      "label": "Bottom Padding (Mobile)",
      "default": 140
    }
  ],
  "blocks": [
    {
      "type": "line",
      "name": "Text Line",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Content",
          "default": "Your Text Here"
        },
        {
          "type": "select",
          "id": "visibility",
          "label": "Visibility",
          "options": [
            { "value": "always", "label": "Always Visible" },
            { "value": "desktop", "label": "Desktop Only" },
            { "value": "mobile", "label": "Mobile Only" }
          ],
          "default": "always",
          "info": "Use this to create different line breaks for mobile."
        },
        {
          "type": "range",
          "id": "base_opacity",
          "min": 0,
          "max": 100,
          "step": 5,
          "unit": "%",
          "label": "Inactive Opacity",
          "default": 30,
          "info": "Opacity when NOT in the center."
        },
        {
          "type": "header",
          "content": "Inactive Sizes"
        },
        {
          "type": "range",
          "id": "base_size_d",
          "min": 16,
          "max": 80,
          "step": 1,
          "unit": "px",
          "label": "Desktop Base Size",
          "default": 48
        },
        {
          "type": "range",
          "id": "base_size_m",
          "min": 12,
          "max": 40,
          "step": 1,
          "unit": "px",
          "label": "Mobile Base Size",
          "default": 24
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Scroll Text Fade",
      "blocks": [
        {
          "type": "line",
          "settings": {
            "text": "At Taima®, Non-Toxic Isn’t A Feature.",
            "visibility": "desktop",
            "base_opacity": 40,
            "base_size_d": 64
          }
        },
        {
          "type": "line",
          "settings": {
            "text": "At Taima®",
            "visibility": "mobile",
            "base_opacity": 40,
            "base_size_m": 30
          }
        },
        {
          "type": "line",
          "settings": {
            "text": "Non-Toxic",
            "visibility": "mobile",
            "base_opacity": 40,
            "base_size_m": 30
          }
        },
        {
          "type": "line",
          "settings": {
            "text": "Isn’t A Feature.",
            "visibility": "mobile",
            "base_opacity": 40,
            "base_size_m": 28
          }
        },
        {
          "type": "line",
          "settings": {
            "text": "It’s The Foundation.",
            "base_opacity": 30,
            "base_size_d": 48
          }
        },
        {
          "type": "line",
          "settings": {
            "text": "Perfection Isn't a Goal.",
            "base_opacity": 20,
            "base_size_d": 48
          }
        },
        {
          "type": "line",
          "settings": {
            "text": "It's Where We Begin.",
            "base_opacity": 10,
            "base_size_d": 32
          }
        }
      ]
    }
  ]
}
{% endschema %}