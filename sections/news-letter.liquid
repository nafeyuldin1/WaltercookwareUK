{%- style -%}
  /* Dynamic Variables */
  #shopify-section-{{ section.id }} .nl-hero {
    --bg: {{ section.settings.color_bg }};
    --accent: {{ section.settings.color_accent }};
    --text: {{ section.settings.color_text }};
    --muted: {{ section.settings.color_subtext }};
    --btn-bg: {{ section.settings.color_btn_bg }};
    --btn-fg: {{ section.settings.color_btn_text }};
    --border: {{ section.settings.color_border }};
  }

  /* Base Styles */
  #shopify-section-{{ section.id }} .nl-hero {
    background: var(--bg);
    color: var(--text);
  }

  #shopify-section-{{ section.id }} .nl-hero__inner {
    max-width: 980px;
    margin: 0 auto;
    padding: 200px 0;
    text-align: center;
  }

  /* Typography */
  #shopify-section-{{ section.id }} .nl-hero__title {
    margin: 0 0 24px;
    font-weight: 400;
    font-size: 48px;
    line-height: 130%;
    letter-spacing: 0.96px;
    color: var(--text);
  }
  
  #shopify-section-{{ section.id }} .nl-hero__title--accent {
    color: var(--accent);
  }

  #shopify-section-{{ section.id }} .nl-hero__sub {
    margin: 0 auto 24px;
    color: var(--muted);
    text-align: center;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 150%;
    letter-spacing: 0.64px;
    max-width: 672px;
  }

  /* Form Styling */
  #shopify-section-{{ section.id }} .nl-hero__shopify-form { margin: 0; }

  #shopify-section-{{ section.id }} .nl-hero__form {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    border-radius: 16px;
    border: 1px solid var(--border);
    max-width: 444px;
    position: relative;
  }

  #shopify-section-{{ section.id }} .nl-hero__input {
    width: min(520px, 72vw);
    height: 54px;
    padding: 0 16px;
    background: transparent;
    outline: none;
    color: var(--muted);
    border: none;
    font-size: 16px;
    font-style: normal;
    font-weight: 400;
    line-height: 150%;
    letter-spacing: 0.64px;
  }
  
  #shopify-section-{{ section.id }} .nl-hero__input::placeholder { color: var(--muted); opacity: 0.7; }

  #shopify-section-{{ section.id }} .nl-hero__btn {
    height: 54px;
    padding: 0 24px;
    border: 0;
    border-radius: 16px;
    background: var(--btn-bg);
    color: var(--btn-fg);
    font-size: 20px;
    font-style: normal;
    font-weight: 500;
    line-height: 100%;
    letter-spacing: 0.8px;
    text-transform: capitalize;
    cursor: pointer;
    transition: transform .12s ease, opacity .12s ease;
    white-space: nowrap;
  }
  
  #shopify-section-{{ section.id }} .nl-hero__btn:hover { transform: translateY(-1px); }
  #shopify-section-{{ section.id }} .nl-hero__btn:active { transform: translateY(0); opacity: .9; }

  #shopify-section-{{ section.id }} .nl-hero__note {
    margin-top: 12px;
    color: var(--muted);
    text-align: center;
    font-size: 14px;
    font-style: normal;
    font-weight: 400;
    line-height: 150%;
    letter-spacing: 0.56px;
  }

  #shopify-section-{{ section.id }} .nl-hero__msg { margin-top: 10px; font-size: 14px; }
  #shopify-section-{{ section.id }} .nl-hero__msg--success { color: var(--muted); font-weight: 700; }
  #shopify-section-{{ section.id }} .nl-hero__msg--error { color: var(--accent); font-weight: 700; }

  /* -------------------------------------- */
  /* RESPONSIVE */
  /* -------------------------------------- */

  /* Mobile (< 750px) */
  @media (max-width: 749px) {
    #shopify-section-{{ section.id }} .nl-hero__inner { padding: 64px 16px; }
    #shopify-section-{{ section.id }} .nl-hero__title { font-size: 32px; letter-spacing: .64px; }
    #shopify-section-{{ section.id }} .nl-hero__form { gap: 10px; }
    #shopify-section-{{ section.id }} .nl-hero__input { width: 100%; }
    #shopify-section-{{ section.id }} .nl-hero__btn { width: 100%; }
  }

  /* Laptop (750px - 1799px) */
  @media (min-width: 750px) and (max-width: 1799px) {
    #shopify-section-{{ section.id }} .nl-hero__inner { max-width: 882px; padding: 180px 0; }
    #shopify-section-{{ section.id }} .nl-hero__title { font-size: 43.2px; letter-spacing: 0.864px; }
    #shopify-section-{{ section.id }} .nl-hero__sub { font-size: 14.4px; letter-spacing: 0.576px; max-width: 605px; }
    #shopify-section-{{ section.id }} .nl-hero__form { gap: 9px; border-radius: 14.4px; max-width: 400px; }
    #shopify-section-{{ section.id }} .nl-hero__input { width: min(468px, 72vw); height: 48.6px; padding: 0 14.4px; font-size: 14.4px; letter-spacing: 0.576px; }
    #shopify-section-{{ section.id }} .nl-hero__btn { height: 48.6px; padding: 0 21.6px; border-radius: 14.4px; font-size: 18px; letter-spacing: 0.72px; }
    #shopify-section-{{ section.id }} .nl-hero__note { margin-top: 10.8px; font-size: 12.6px; letter-spacing: 0.504px; }
    #shopify-section-{{ section.id }} .nl-hero__msg { margin-top: 9px; font-size: 12.6px; }
  }

  /* Large Screens (2200px+) */
  @media (min-width: 2200px) {
    #shopify-section-{{ section.id }} .nl-hero__inner { max-width: 1274px; padding: 260px 0; }
    #shopify-section-{{ section.id }} .nl-hero__title { font-size: 62.4px; letter-spacing: 1.248px; }
    #shopify-section-{{ section.id }} .nl-hero__sub { font-size: 20.8px; letter-spacing: 0.832px; max-width: 874px; }
    #shopify-section-{{ section.id }} .nl-hero__form { gap: 13px; border-radius: 20.8px; max-width: 577px; }
    #shopify-section-{{ section.id }} .nl-hero__input { width: min(676px, 72vw); height: 70.2px; padding: 0 20.8px; font-size: 20.8px; letter-spacing: 0.832px; }
    #shopify-section-{{ section.id }} .nl-hero__btn { height: 70.2px; padding: 0 31.2px; border-radius: 20.8px; font-size: 26px; letter-spacing: 1.04px; }
    #shopify-section-{{ section.id }} .nl-hero__note { margin-top: 15.6px; font-size: 18.2px; letter-spacing: 0.728px; }
    #shopify-section-{{ section.id }} .nl-hero__msg { margin-top: 13px; font-size: 18.2px; }
  }

  /* Screen-reader only */
  #shopify-section-{{ section.id }} .sr-only {
    position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
  }
{%- endstyle -%}

<section id="nl-section-{{ section.id }}" class="nl-hero" role="region" aria-label="Newsletter">
  <div class="nl-hero__inner">
    
    <h2 class="nl-hero__title">
      {%- if section.settings.heading_accent != blank -%}
        <span class="nl-hero__title--accent">{{ section.settings.heading_accent }}</span><br>
      {%- endif -%}
      <span>{{ section.settings.heading_main }}</span>
    </h2>

    {%- if section.settings.subtext != blank -%}
      <div class="nl-hero__sub rte">
        {{ section.settings.subtext }}
      </div>
    {%- endif -%}
    
    <form method="post" action="/contact#nl-form-{{ section.id }}" id="nl-form-{{ section.id }}" accept-charset="UTF-8" class="nl-hero__shopify-form">
      <input type="hidden" name="form_type" value="customer">
      <input type="hidden" name="utf8" value="✓">
      <input type="hidden" name="contact[tags]" value="newsletter">
      
      <label class="sr-only" for="nl-email-{{ section.id }}">Email</label>

      <div class="nl-hero__form">
        <input id="nl-email-{{ section.id }}" class="nl-hero__input" type="email" name="contact[email]" value="" autocapitalize="off" autocomplete="email" placeholder="{{ section.settings.placeholder }}" required>
        <button class="nl-hero__btn" type="button">
          {{ section.settings.button_text }}
        </button>
      </div>

      <p class="nl-hero__msg nl-hero__msg--client" aria-live="polite" hidden></p>
    </form>

    {%- if section.settings.spam_note != blank -%}
      <div class="nl-hero__note">{{ section.settings.spam_note }}</div>
    {%- endif -%}

  </div>
</section>

<script>
(function () {
  const section = document.getElementById('nl-section-{{ section.id }}');
  if (!section) return;

  const form = section.querySelector('form.nl-hero__shopify-form');
  if (!form) return;

  const btn = form.querySelector('.nl-hero__btn');
  const emailInput = form.querySelector('input[name="contact[email]"]');

  // 1) Prevent default submission
  form.addEventListener('submit', function (ev) {
    ev.preventDefault();
    ev.stopImmediatePropagation();
  }, true);

  // 2) Reuse message node
  let liveMsg = form.querySelector('.nl-hero__msg--client');

  async function submitAjax() {
    if (!form.checkValidity()) {
      form.reportValidity?.();
      return;
    }

    const prevLabel = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Submitting...';
    liveMsg.hidden = true;
    liveMsg.textContent = '';
    liveMsg.classList.remove('nl-hero__msg--success', 'nl-hero__msg--error');

    try {
      const fd = new FormData(form);
      // Native Shopify endpoint handles this automatically via the action URL
      
      const res = await fetch(form.action, {
        method: 'POST',
        body: fd,
        credentials: 'same-origin',
        headers: { 'Accept': 'text/html' }
      });

      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      
      // Look for the form in the response to check for errors/success
      const returnedForm = doc.getElementById('nl-form-{{ section.id }}') || doc.querySelector('form[action^="/contact"]');
      
      // Shopify usually returns the form with a 'contact-posted' class or errors inside
      const serverSuccess = doc.querySelector('.form-status-list--success') || doc.querySelector('.form-success') || returnedForm?.querySelector('.nl-hero__msg--success');
      const serverError = doc.querySelector('.errors') || returnedForm?.querySelector('.nl-hero__msg--error');

      if (html.includes('contact_form') && !html.includes('errors')) {
         // Shopify success usually redirects to anchor #contact_form or contains specific success classes
         liveMsg.textContent = '{{ section.settings.success_message }}';
         liveMsg.classList.add('nl-hero__msg--success');
         liveMsg.hidden = false;
         if (emailInput) emailInput.value = '';
      } else if (serverError) {
         liveMsg.textContent = serverError.textContent.trim() || 'Please check your email and try again.';
         liveMsg.classList.add('nl-hero__msg--error');
         liveMsg.hidden = false;
      } else {
         // Fallback success if no errors detected
         liveMsg.textContent = '{{ section.settings.success_message }}';
         liveMsg.classList.add('nl-hero__msg--success');
         liveMsg.hidden = false;
         if (emailInput) emailInput.value = '';
      }
    } catch (e) {
      liveMsg.textContent = 'Network error—please try again.';
      liveMsg.classList.add('nl-hero__msg--error');
      liveMsg.hidden = false;
    } finally {
      btn.disabled = false;
      btn.textContent = prevLabel;
    }
  }

  // 3) Trigger AJAX on click
  btn?.addEventListener('click', submitAjax);

  // 4) Trigger AJAX on Enter key
  emailInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      submitAjax();
    }
  });
})();
</script>

{% schema %}
{
  "name": "Newsletter Hero",
  "settings": [
    {
      "type": "header",
      "content": "Text Content"
    },
    {
      "type": "text",
      "id": "heading_accent",
      "label": "Heading (Accent Part)",
      "default": "You Deserve Better"
    },
    {
      "type": "text",
      "id": "heading_main",
      "label": "Heading (Main Part)",
      "default": "Than Random Emails."
    },
    {
      "type": "richtext",
      "id": "subtext",
      "label": "Description",
      "default": "<p>We only send you things worth opening. Breakthroughs, exclusive launches, toxin-free living tips, and the latest in innovation - before the rest of the world catches on.</p>"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Input Placeholder",
      "default": "Email"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Label",
      "default": "Subscribe"
    },
    {
      "type": "text",
      "id": "spam_note",
      "label": "Anti-Spam Note",
      "default": "We hate spam too."
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success Message",
      "default": "Success! You’re In!"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "color_bg",
      "label": "Background",
      "default": "#03231a"
    },
    {
      "type": "color",
      "id": "color_accent",
      "label": "Accent Text (Top Heading)",
      "default": "#bca588"
    },
    {
      "type": "color",
      "id": "color_text",
      "label": "Main Text",
      "default": "#f6f4f0"
    },
    {
      "type": "color",
      "id": "color_subtext",
      "label": "Subtext / Placeholder",
      "default": "#B0B0B0"
    },
    {
      "type": "color",
      "id": "color_border",
      "label": "Input Border Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "color_btn_bg",
      "label": "Button Background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "color_btn_text",
      "label": "Button Text",
      "default": "#121212"
    }
  ],
  "presets": [
    {
      "name": "Newsletter Hero"
    }
  ]
}
{% endschema %}