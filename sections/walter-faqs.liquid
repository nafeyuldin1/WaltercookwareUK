{% schema %}
{
  "name": "FAQ Accordion",
  "settings": [
    {
      "type": "header",
      "content": "Section Colors"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#BCA588"
    },
    {
      "type": "color",
      "id": "question_color",
      "label": "Question Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "answer_color",
      "label": "Answer Text Color",
      "default": "#B0B0B0"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Line Color",
      "default": "#454545"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Plus/Minus Icon Color",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Frequently Asked Questions"
    },
    {
      "type": "checkbox",
      "id": "open_first",
      "label": "Open first question by default",
      "default": true
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Padding Top (Desktop)",
      "default": 120
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom (Desktop)",
      "default": 120
    },
    {
      "type": "range",
      "id": "padding_top_m",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top (Mobile)",
      "default": 64
    },
    {
      "type": "range",
      "id": "padding_bottom_m",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom (Mobile)",
      "default": 64
    }
  ],
  "blocks": [
    {
      "type": "faq_item",
      "name": "Question",
      "settings": [
        {
          "type": "text",
          "id": "question",
          "label": "Question",
          "default": "Add your question here"
        },
        {
          "type": "richtext",
          "id": "answer",
          "label": "Answer",
          "default": "<p>Add your answer text here. You can use bold, italics, and lists.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "FAQ Accordion",
      "blocks": [
        {
          "type": "faq_item",
          "settings": {
            "question": "How does SlipScale™ non-stick surface work?",
            "answer": "<p>This technology is the very first of its kind, setting a new standard in cookware. SlipScale™ is our engineered, no-coating imprinted surface pattern that increases food release by up to 3x.</p>"
          }
        },
        {
          "type": "faq_item",
          "settings": {
            "question": "How does titanium cookware help food retain more nutrients?",
            "answer": "<p>Pure Titanium’s superior thermal conductivity allows you to cook evenly at lower temperatures. Studies show that lower-temp cooking helps retain up to 30% more nutrients.</p>"
          }
        },
        {
          "type": "faq_item",
          "settings": {
            "question": "Why should I switch from my existing pan?",
            "answer": "<p>Because no other pan protects your health, keeps nutrients intact, and lasts for decades like this one.</p>"
          }
        },
        {
          "type": "faq_item",
          "settings": {
            "question": "Is titanium safe for food contact?",
            "answer": "<p>Yes. Titanium never leaches, corrodes, or reacts with your food, at any temperature.</p>"
          }
        },
        {
          "type": "faq_item",
          "settings": {
            "question": "Is it safe to use on all stovetops and ovens?",
            "answer": "<p>Yes. The Taima® Titanium cookware works on every cooking surface - gas, electric, ceramic, induction, open flame & oven.</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}

<div id="section-{{ section.id }}" class="shopify-section-faq">
  <div class="faq-section">
    <div class="faq-wrapper">
      {% if section.settings.heading != blank %}
        <h2 class="faq-heading">{{ section.settings.heading }}</h2>
      {% endif %}

      <div class="faq-container">
        {% for block in section.blocks %}
          {% assign is_open = false %}
          {% if section.settings.open_first and forloop.first %}
            {% assign is_open = true %}
          {% endif %}

          <div class="faq-item {% if is_open %}open{% endif %}" {{ block.shopify_attributes }}>
            <div class="faq-question">
              <span>{{ block.settings.question }}</span>
              <span class="faq-toggle-icon">
                <span class="icon-plus">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M12 5.5L12 18.5M18.5 12L5.5 12" stroke="{{ section.settings.icon_color }}" stroke-width="1.5"></path>
                  </svg>
                </span>
                <span class="icon-minus">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <line x1="18.5" y1="12.75" x2="5.5" y2="12.75" stroke="{{ section.settings.icon_color }}" stroke-width="1.5"></line>
                  </svg>
                </span>
              </span>
            </div>
            
            <div class="faq-answer {% unless is_open %}faq-anim-collapsed{% endunless %}" 
                 style="{% if is_open %}height: auto; opacity: 1;{% else %}height: 0px; opacity: 0;{% endif %}">
              <div class="faq-answer__inner">
                {{ block.settings.answer }}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
      
    </div>
  </div>
</div>

<style>
  /* Scoped Variables */
  #section-{{ section.id }} {
    --bg-color: {{ section.settings.bg_color }};
    --heading-color: {{ section.settings.heading_color }};
    --question-color: {{ section.settings.question_color }};
    --answer-color: {{ section.settings.answer_color }};
    --border-color: {{ section.settings.border_color }};
    --pt-desktop: {{ section.settings.padding_top }}px;
    --pb-desktop: {{ section.settings.padding_bottom }}px;
    --pt-mobile: {{ section.settings.padding_top_m }}px;
    --pb-mobile: {{ section.settings.padding_bottom_m }}px;
  }

  #section-{{ section.id }} .faq-section {
    background: var(--bg-color);
    padding-top: var(--pt-desktop);
    padding-bottom: var(--pb-desktop);
    color: white;
  }

  #section-{{ section.id }} .faq-wrapper {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 16px;
  }

  #section-{{ section.id }} .faq-heading {
    text-align: center;
    font-family: 'Neue Montreal', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: 400;
    font-size: 48px;
    line-height: 130%;
    letter-spacing: 0.04em;
    text-transform: capitalize;
    color: var(--heading-color);
    margin: 0 0 48px 0;
  }

  #section-{{ section.id }} .faq-item {
    border-top: 1px solid var(--border-color);
  }

  /* Only hide border-top for the 2nd child IF the first child logic was hardcoded, 
     but dynamically it's better to stick to standard borders. 
     Keeping user's style preference: */
  #section-{{ section.id }} .faq-item:first-child {
    border-top: 1px solid var(--border-color); /* Restored for consistency */
  }

  #section-{{ section.id }} .faq-item:last-child {
    border-bottom: 1px solid var(--border-color);
  }

  #section-{{ section.id }} .faq-question {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    padding: 18px 0;
  }

  #section-{{ section.id }} .faq-question span {
    font-family: 'Neue Montreal', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: 500;
    font-size: 20px;
    line-height: 140%;
    letter-spacing: 0.02em;
    text-transform: capitalize;
    color: var(--question-color);
  }

  #section-{{ section.id }} .faq-toggle-icon {
    display: flex;
    align-items: center;
  }

  #section-{{ section.id }} .icon-plus, 
  #section-{{ section.id }} .icon-minus {
    display: none;
  }

  #section-{{ section.id }} .faq-item .icon-plus { display: inline-block; }
  #section-{{ section.id }} .faq-item.open .icon-plus { display: none; }
  #section-{{ section.id }} .faq-item.open .icon-minus { display: inline-block; }

  /* Animation Logic */
  #section-{{ section.id }} .faq-answer {
    height: 0;
    opacity: 0;
    overflow: hidden;
    transition: height 450ms ease, opacity 450ms ease;
    will-change: height, opacity;
  }

  #section-{{ section.id }} .faq-answer__inner {
    padding-bottom: 24px;
    font-family: 'Neue Montreal', sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: 400;
    font-size: 16px;
    line-height: 150%;
    letter-spacing: 0.04em;
    color: var(--answer-color);
  }

  #section-{{ section.id }} .faq-answer__inner p {
    margin: 0 0 10px 0;
  }
  #section-{{ section.id }} .faq-answer__inner p:last-child {
    margin-bottom: 0;
  }

  #section-{{ section.id }} .faq-answer__inner strong {
    font-weight: 500 !important;
    color: #fff;
  }

  /* Helper Classes */
  #section-{{ section.id }} .faq-answer.faq-anim-collapsed { height: 0; opacity: 0; }
  #section-{{ section.id }} .faq-answer:not(.faq-anim-collapsed) { opacity: 1 !important; }
  #section-{{ section.id }} .faq-answer.faq-anim-closing { transition: height 450ms ease, opacity 450ms ease; }

  /* Responsive */
  @media (max-width: 768px) {
    #section-{{ section.id }} .faq-section {
      padding-top: var(--pt-mobile);
      padding-bottom: var(--pb-mobile);
    }
    #section-{{ section.id }} .faq-heading { font-size: 24px; margin-bottom: 32px; }
    #section-{{ section.id }} .faq-question span { font-size: 14px; }
  }

  @media (min-width: 2200px) {
    #section-{{ section.id }} .faq-section { 
      padding-top: calc(var(--pt-desktop) * 1.3);
      padding-bottom: calc(var(--pb-desktop) * 1.3);
    }
    #section-{{ section.id }} .faq-wrapper { max-width: 1170px; padding: 0 20.8px; }
    #section-{{ section.id }} .faq-heading { font-size: 62.4px; margin-bottom: 62.4px; letter-spacing: 0.052em; }
    #section-{{ section.id }} .faq-item { border-top-width: 1.3px; }
    #section-{{ section.id }} .faq-item:last-child { border-bottom-width: 1.3px; }
    #section-{{ section.id }} .faq-question { padding: 23.4px 0; }
    #section-{{ section.id }} .faq-question span { font-size: 26px; letter-spacing: 0.026em; }
    #section-{{ section.id }} .faq-toggle-icon svg { width: 31.2px; height: 31.2px; }
    #section-{{ section.id }} .faq-item.open .faq-question { padding: 0 0 20.8px 0; }
    #section-{{ section.id }} .faq-answer__inner { font-size: 20.8px; letter-spacing: 0.052em; padding-bottom: 31.2px; }
  }
</style>

<script>
(function() {
  function initFAQ(root) {
    if (!root) return;
    
    const items = Array.from(root.querySelectorAll(".faq-item"));
    const questions = Array.from(root.querySelectorAll(".faq-question"));
    const answers = Array.from(root.querySelectorAll(".faq-answer"));

    function closePanel(panel) {
      if (!panel || panel.classList.contains("faq-anim-collapsed")) return;
      panel.style.height = panel.scrollHeight + "px";
      panel.getBoundingClientRect(); // force reflow
      panel.classList.add("faq-anim-closing");
      panel.classList.add("faq-anim-collapsed");
      panel.style.height = "0px";
    }

    function openPanel(panel) {
      if (!panel || !panel.classList.contains("faq-anim-collapsed")) return;
      panel.classList.remove("faq-anim-collapsed");
      panel.style.height = "0px";
      requestAnimationFrame(() => {
        panel.style.height = panel.scrollHeight + "px";
      });
    }

    function onTransitionEnd(e) {
      const panel = e.currentTarget;
      if (e.propertyName !== "height") return;
      if (!panel.classList.contains("faq-anim-collapsed")) {
        panel.style.height = "auto";
        panel.classList.remove("faq-anim-closing");
      } else {
        panel.classList.remove("faq-anim-closing");
      }
    }
    
    // Clean up old listeners to avoid duplicates if re-initialized
    answers.forEach(p => {
       p.removeEventListener("transitionend", onTransitionEnd);
       p.addEventListener("transitionend", onTransitionEnd);
    });

    // Initialize state
    items.forEach((item) => {
      const panel = item.querySelector(".faq-answer");
      if (!panel) return;
      if (item.classList.contains("open")) {
        panel.classList.remove("faq-anim-collapsed");
        panel.style.height = "auto";
        panel.style.opacity = "1";
      } else {
        panel.classList.add("faq-anim-collapsed");
        panel.style.height = "0px";
        panel.style.opacity = "0";
      }
    });

    // Click handlers
    questions.forEach((q) => {
      // Clone node to remove old listeners effectively if re-init
      const newQ = q.cloneNode(true);
      q.parentNode.replaceChild(newQ, q);
      
      newQ.addEventListener("click", () => {
        const item = newQ.closest(".faq-item");
        if (!item) return;
        const panel = item.querySelector(".faq-answer");
        const wasOpen = item.classList.contains("open");

        // Close others in this section
        items.forEach((it) => {
          if (it !== item && it.classList.contains("open")) {
            it.classList.remove("open");
            const p = it.querySelector(".faq-answer");
            closePanel(p);
          }
        });

        // Toggle clicked
        if (wasOpen) {
          item.classList.remove("open");
          closePanel(panel);
        } else {
          item.classList.add("open");
          openPanel(panel);
        }
      });
    });
  }

  // Init on Load
  document.addEventListener("DOMContentLoaded", function () {
    const sections = document.querySelectorAll("#section-{{ section.id }}");
    sections.forEach(initFAQ);
  });

  // Init on Theme Editor Update
  document.addEventListener("shopify:section:load", function(e) {
    if(e.detail.sectionId === "{{ section.id }}") {
      const root = e.target.querySelector("#section-{{ section.id }}");
      initFAQ(root);
    }
  });
})();
</script>