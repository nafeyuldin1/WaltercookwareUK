{% comment %}
  Section: Health Features (Dynamic)
  Description: Feature list with central image and mobile scroll interaction.
{% endcomment %}

{%- style -%}
  #shopify-section-{{ section.id }} .health-features {
    background-color: {{ section.settings.bg_color }};
    color: {{ section.settings.text_color }};
    overflow: hidden;
  }

  #shopify-section-{{ section.id }} .hf__inner {
    max-width: {{ section.settings.max_width }}px;
    margin: 0 auto;
    padding-top: {{ section.settings.pt_d }}px;
    padding-bottom: {{ section.settings.pb_d }}px;
    padding-left: {{ section.settings.pad_x_d }}px;
    padding-right: {{ section.settings.pad_x_d }}px;
    position: relative;
  }

  /* Typography */
  #shopify-section-{{ section.id }} .hf__title {
    margin: 0 0 48px;
    color: {{ section.settings.heading_color }};
    font-size: {{ section.settings.heading_size_d }}px;
    font-weight: 400;
    line-height: 1.3;
    text-transform: capitalize;
    text-align: center;
  }

  /* Grid Layout */
  #shopify-section-{{ section.id }} .hf__grid {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  #shopify-section-{{ section.id }} .hf__list {
    display: grid;
    gap: 40px;
    list-style: none;
    padding: 73px 0;
    margin: 0;
    flex: 1;
  }

  /* Items */
  #shopify-section-{{ section.id }} .hf-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    color: {{ section.settings.text_muted }};
    transition: color 0.2s ease, opacity 0.2s ease;
  }

  /* Left List Alignment */
  #shopify-section-{{ section.id }} .hf__list--left .hf-item {
    justify-content: flex-end;
    text-align: right;
  }

  /* Right List Alignment */
  #shopify-section-{{ section.id }} .hf__list--right .hf-item {
    justify-content: flex-start;
    text-align: left;
  }

  #shopify-section-{{ section.id }} .hf-item__text {
    color: {{ section.settings.text_item }};
    font-size: {{ section.settings.item_size_d }}px;
    font-weight: 500;
    line-height: 1.4;
    text-transform: capitalize;
  }

  #shopify-section-{{ section.id }} .hf-item__icon {
    width: 48px;
    height: 48px;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: {{ section.settings.icon_color }};
  }

  #shopify-section-{{ section.id }} .hf-item__icon svg,
  #shopify-section-{{ section.id }} .hf-item__icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }
  
  /* SVG Stroke Color Override */
  #shopify-section-{{ section.id }} .hf-item__icon svg path {
    stroke: {{ section.settings.icon_color }};
  }

  /* Central Media */
  #shopify-section-{{ section.id }} .hf__media {
    display: flex;
    align-items: center;
    justify-content: center;
    flex: 1.5; /* Takes more space in center */
    padding: 0 20px;
    position: relative; 
  }

  #shopify-section-{{ section.id }} .hf__img {
    width: 100%;
    height: auto;
    max-width: 864px;
    display: block;
    user-select: none;
    pointer-events: none;
  }

  /* Responsive Mobile */
  @media (max-width: 900px) {
    #shopify-section-{{ section.id }} .hf__inner {
      padding-top: {{ section.settings.pt_m }}px;
      padding-bottom: {{ section.settings.pb_m }}px;
      padding-left: {{ section.settings.pad_x_m }}px;
      padding-right: {{ section.settings.pad_x_m }}px;
    }

    #shopify-section-{{ section.id }} .hf__title {
      font-size: {{ section.settings.heading_size_m }}px;
      max-width: 358px;
      margin: 0 auto 32px;
    }

    #shopify-section-{{ section.id }} .hf__grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
    }

    /* Mobile Reordering: Right List (Top), Image (Middle), Left List (Bottom) */
    #shopify-section-{{ section.id }} .hf__list--right { order: 1; display: flex; flex-direction: column-reverse; }
    #shopify-section-{{ section.id }} .hf__media { order: 2; padding: 0; }
    #shopify-section-{{ section.id }} .hf__list--left { order: 3; }

    #shopify-section-{{ section.id }} .hf__list {
      gap: 16px;
      padding: 0;
    }

    #shopify-section-{{ section.id }} .hf-item {
      justify-content: center !important; /* Force center on mobile */
      text-align: center !important;
      opacity: 0.5; /* Inactive state */
      transform-origin: center;
      transition: all 0.3s ease;
    }

    /* Mobile Active State */
    #shopify-section-{{ section.id }} .hf-item.is-active {
      opacity: 1;
      transform: scale(1.05);
    }

    #shopify-section-{{ section.id }} .hf-item.is-active .hf-item__text {
      color: {{ section.settings.active_text_color }};
      font-size: {{ section.settings.item_size_m_active }}px;
    }
    
    #shopify-section-{{ section.id }} .hf-item.is-active .hf-item__icon {
      width: 32px;
      height: 32px;
    }
    
    #shopify-section-{{ section.id }} .hf-item.is-active .hf-item__icon svg path {
      stroke: {{ section.settings.active_icon_color }};
    }

    #shopify-section-{{ section.id }} .hf-item__text {
      font-size: {{ section.settings.item_size_m }}px;
    }

    #shopify-section-{{ section.id }} .hf-item__icon {
      width: 24px;
      height: 24px;
    }
  }
{%- endstyle -%}

<section id="health-features-{{ section.id }}" class="health-features">
  <div class="hf__inner">
    
    {%- if section.settings.heading != blank -%}
      <h2 class="hf__title">{{ section.settings.heading }}</h2>
    {%- endif -%}

    <div class="hf__grid">
      
      <ul class="hf__list hf__list--left" aria-label="Left features">
        {%- for block in section.blocks -%}
          {%- if block.settings.position == 'left' -%}
            <li class="hf-item" data-side="left" {{ block.shopify_attributes }}>
              <span class="hf-item__text">{{ block.settings.text }}</span>
              <span class="hf-item__icon" aria-hidden="true">
                {%- if block.settings.icon_image != blank -%}
                  {{ block.settings.icon_image | image_url: width: 100 | image_tag }}
                {%- elsif block.settings.icon_svg != blank -%}
                  {{ block.settings.icon_svg }}
                {%- else -%}
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="49" viewBox="0 0 48 49" fill="none"><circle cx="24" cy="24.5" r="10" stroke="currentColor" stroke-width="2"/></svg>
                {%- endif -%}
              </span>
            </li>
          {%- endif -%}
        {%- endfor -%}
      </ul>

      <div class="hf__media">
        {%- assign desktop_img = section.settings.image_desktop -%}
        {%- assign mobile_img = section.settings.image_mobile | default: desktop_img -%}
        {%- assign swap_img = section.settings.image_swap | default: mobile_img -%}
        
        {%- if desktop_img != blank -%}
          <img class="hf__img" 
               src="{{ desktop_img | image_url: width: 1200 }}" 
               alt="{{ desktop_img.alt | escape }}" 
               data-desktop="{{ desktop_img | image_url: width: 1200 }}" 
               data-mobile="{{ mobile_img | image_url: width: 800 }}" 
               data-swap-mobile="{{ swap_img | image_url: width: 800 }}" 
               loading="lazy">
        {%- else -%}
          {{ 'product-1' | placeholder_svg_tag: 'hf__img' }}
        {%- endif -%}
      </div>

      <ul class="hf__list hf__list--right" aria-label="Right features">
        {%- for block in section.blocks -%}
          {%- if block.settings.position == 'right' -%}
            <li class="hf-item" data-side="right" {{ block.shopify_attributes }}>
              <span class="hf-item__icon" aria-hidden="true">
                {%- if block.settings.icon_image != blank -%}
                  {{ block.settings.icon_image | image_url: width: 100 | image_tag }}
                {%- elsif block.settings.icon_svg != blank -%}
                  {{ block.settings.icon_svg }}
                {%- else -%}
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="49" viewBox="0 0 48 49" fill="none"><circle cx="24" cy="24.5" r="10" stroke="currentColor" stroke-width="2"/></svg>
                {%- endif -%}
              </span>
              <span class="hf-item__text">{{ block.settings.text }}</span>
            </li>
          {%- endif -%}
        {%- endfor -%}
      </ul>

    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function(){
  var root = document.getElementById('health-features-{{ section.id }}');
  if (!root) return;

  var mql = window.matchMedia('(max-width: 900px)');
  var img = root.querySelector('.hf__img');
  if (!img) return;

  // Get URLs from data attributes
  var desktopDefault = img.getAttribute('data-desktop') || img.src;
  var mobileDefault  = img.getAttribute('data-mobile') || desktopDefault;
  var swapMobile     = img.getAttribute('data-swap-mobile') || mobileDefault;

  var rafId = null;

  // Pick exactly ONE active item: the one closest to viewport center
  function setActiveAndSyncImage(){
    var isMobile = mql.matches;

    // 1) Find the best item
    var items = Array.from(root.querySelectorAll('.hf-item'));
    if (!items.length) return;

    var vc = window.innerHeight / 2;
    var best = null, bestDist = Infinity;

    items.forEach(function(el){
      var r = el.getBoundingClientRect();
      if (r.bottom <= 0 || r.top >= window.innerHeight) return; 
      var dist = Math.abs((r.top + r.height/2) - vc);
      if (dist < bestDist) { bestDist = dist; best = el; }
    });

    if (!best && items.length > 0) best = items[0];

    // 2) Apply active class
    items.forEach(function(el){ el.classList.toggle('is-active', el === best); });

    // 3) Image swap logic (Mobile only)
    // If active item is in the Left List (which is usually bottom on mobile), use swap image
    if (isMobile && best) {
      var bestIsInLeftList = !!best.closest('.hf__list--left');
      var targetSrc = bestIsInLeftList ? swapMobile : mobileDefault;
      if (targetSrc && img.src !== targetSrc) img.src = targetSrc;
    } else {
      // Desktop reset
      if (img.src !== desktopDefault) img.src = desktopDefault;
    }
  }

  function onScrollOrResize(){
    if (!mql.matches) return; 
    if (rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(setActiveAndSyncImage);
  }

  function handle(){
    if(mql.matches){
      window.addEventListener('scroll', onScrollOrResize, { passive: true });
      window.addEventListener('resize', onScrollOrResize);
      setActiveAndSyncImage(); // Run once immediately
    } else {
      window.removeEventListener('scroll', onScrollOrResize);
      window.removeEventListener('resize', onScrollOrResize);
      img.src = desktopDefault; // Reset to desktop
      // Remove active classes
      root.querySelectorAll('.hf-item').forEach(function(el){ el.classList.remove('is-active'); });
    }
  }

  handle();
  mql.addEventListener('change', handle);

  // Shopify Editor Support
  document.addEventListener('shopify:section:load', function(e){
    if (e.detail.sectionId === '{{ section.id }}') handle();
  });
});
</script>

{% schema %}
{
  "name": "Health Features",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "The Kitchenware Your Body Deserves"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#BCA588"
    },
    {
      "type": "range",
      "id": "heading_size_d",
      "min": 20,
      "max": 80,
      "step": 2,
      "unit": "px",
      "label": "Heading Size (Desktop)",
      "default": 48
    },
    {
      "type": "range",
      "id": "heading_size_m",
      "min": 16,
      "max": 40,
      "step": 1,
      "unit": "px",
      "label": "Heading Size (Mobile)",
      "default": 24
    },
    {
      "type": "header",
      "content": "Images"
    },
    {
      "type": "image_picker",
      "id": "image_desktop",
      "label": "Center Image (Desktop/Default)"
    },
    {
      "type": "image_picker",
      "id": "image_mobile",
      "label": "Mobile Image 1 (Top List)",
      "info": "Shown when scrolling through the Right list (Top on mobile)."
    },
    {
      "type": "image_picker",
      "id": "image_swap",
      "label": "Mobile Image 2 (Bottom List)",
      "info": "Shown when scrolling through the Left list (Bottom on mobile)."
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#03231A"
    },
    {
      "type": "color",
      "id": "text_item",
      "label": "Item Text Color",
      "default": "#D4C7B4"
    },
    {
      "type": "color",
      "id": "text_muted",
      "label": "Inactive Text Color",
      "default": "#B9B2A8"
    },
    {
      "type": "color",
      "id": "icon_color",
      "label": "Icon Color",
      "default": "#C9AD8E"
    },
    {
      "type": "color",
      "id": "active_text_color",
      "label": "Active Text Color (Mobile)",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "active_icon_color",
      "label": "Active Icon Color (Mobile)",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Typography & Layout"
    },
    {
      "type": "range",
      "id": "item_size_d",
      "min": 14,
      "max": 40,
      "label": "Item Text Size (Desktop)",
      "default": 24
    },
    {
      "type": "range",
      "id": "item_size_m",
      "min": 12,
      "max": 30,
      "label": "Item Text Size (Mobile)",
      "default": 14
    },
    {
      "type": "range",
      "id": "item_size_m_active",
      "min": 14,
      "max": 30,
      "label": "Active Item Size (Mobile)",
      "default": 20
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 1000,
      "max": 2000,
      "step": 20,
      "default": 1920,
      "label": "Max Width"
    },
    {
      "type": "range",
      "id": "pt_d",
      "min": 0,
      "max": 200,
      "step": 5,
      "label": "Top Padding (Desktop)",
      "default": 80
    },
    {
      "type": "range",
      "id": "pb_d",
      "min": 0,
      "max": 200,
      "step": 5,
      "label": "Bottom Padding (Desktop)",
      "default": 80
    },
    {
      "type": "range",
      "id": "pad_x_d",
      "min": 0,
      "max": 200,
      "step": 5,
      "label": "Side Padding (Desktop)",
      "default": 160
    },
    {
      "type": "range",
      "id": "pt_m",
      "min": 0,
      "max": 100,
      "step": 2,
      "label": "Top Padding (Mobile)",
      "default": 56
    },
    {
      "type": "range",
      "id": "pb_m",
      "min": 0,
      "max": 100,
      "step": 2,
      "label": "Bottom Padding (Mobile)",
      "default": 56
    },
    {
      "type": "range",
      "id": "pad_x_m",
      "min": 0,
      "max": 50,
      "step": 2,
      "label": "Side Padding (Mobile)",
      "default": 16
    }
  ],
  "blocks": [
    {
      "type": "feature",
      "name": "Feature Item",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Feature Text",
          "default": "Feature Name"
        },
        {
          "type": "select",
          "id": "position",
          "label": "Position",
          "options": [
            { "value": "left", "label": "Left Side" },
            { "value": "right", "label": "Right Side" }
          ],
          "default": "left"
        },
        {
          "type": "html",
          "id": "icon_svg",
          "label": "Icon SVG Code",
          "info": "Paste SVG code here. Overrides image."
        },
        {
          "type": "image_picker",
          "id": "icon_image",
          "label": "Icon Image",
          "info": "Fallback if no SVG provided."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Health Features",
      "blocks": [
        { "type": "feature", "settings": { "text": "No Toxins", "position": "left" } },
        { "type": "feature", "settings": { "text": "Biocompatible", "position": "left" } },
        { "type": "feature", "settings": { "text": "Extremely Hygienic", "position": "left" } },
        { "type": "feature", "settings": { "text": "Mold Resistant", "position": "left" } },
        { "type": "feature", "settings": { "text": "No Cross-Contamination", "position": "left" } },
        { "type": "feature", "settings": { "text": "No Heavy Metals", "position": "right" } },
        { "type": "feature", "settings": { "text": "Safe At Any Temperature", "position": "right" } },
        { "type": "feature", "settings": { "text": "Effortless To Clean", "position": "right" } },
        { "type": "feature", "settings": { "text": "Never Breaks Down", "position": "right" } },
        { "type": "feature", "settings": { "text": "Sustainable By Design", "position": "right" } }
      ]
    }
  ]
}
{% endschema %}